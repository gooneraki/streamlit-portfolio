# Copilot Instructions for Streamlit Portfolio

This is a Python Streamlit application for analyzing historical financial data from Yahoo Finance. The app helps users analyze individual assets, currencies, portfolios, market sectors, and US market data with comprehensive visualizations and statistics.

## Project Overview

**Purpose**: Personal finance analysis tool providing historical performance insights for assets, currencies, and portfolios.

**Core Features**:
- Single asset analysis with trends and statistics
- Portfolio performance evaluation with optimization strategies
- Currency and cryptocurrency historical data
- Market sector analysis
- US market overview
- Interactive visualizations with Plotly and Altair

## Technology Stack

**Core Technologies**:
- **Python 3.12+** - Main programming language
- **Streamlit 1.46+** - Web application framework
- **yfinance 0.2.64** - Yahoo Finance data fetching
- **pandas 2.3.0** - Data manipulation and analysis
- **numpy 2.3.1** - Numerical computations
- **plotly 6.2.0** - Interactive charts and visualizations
- **altair 5.5.0** - Statistical visualizations
- **scipy 1.16.0** - Statistical analysis and optimization

**Development Tools**:
- **pylint** - Code linting with configuration in `.pylintrc`
- **PowerShell scripts** - Environment setup and application running

## Project Structure

```
📁 streamlit-portfolio/
├── 📄 Home.py                    # Main entry point and home page
├── 📁 pages/                     # Streamlit pages
│   ├── 📄 1_Symbol_View.py       # Individual asset analysis
│   ├── 📄 2_Currency_View.py     # Currency pair analysis
│   ├── 📄 3_Portfolio_View.py    # Portfolio analysis and optimization
│   ├── 📄 4_Sectors.py           # Market sector analysis
│   └── 📄 5_US_Market.py         # US market overview
├── 📁 utilities/                 # Core utility modules
│   ├── 📄 app_yfinance.py        # Yahoo Finance API wrapper
│   ├── 📄 utilities.py           # General utility functions
│   ├── 📄 constants.py           # Application constants
│   └── 📄 go_charts.py           # Plotly chart utilities
├── 📁 classes/                   # Data classes and models
│   ├── 📄 asset_positions.py     # Portfolio and asset position classes
│   └── 📄 exp_fit_backtester.py  # Backtesting functionality
├── 📄 requirements.txt           # Python dependencies
├── 📄 .pylintrc                  # Linting configuration
└── 📄 1_setup_env.ps1           # Environment setup script
```

## Code Style and Conventions

**General Guidelines**:
- Follow PEP 8 Python style guide
- Maximum line length: 120 characters (configured in `.pylintrc`)
- Use type hints for function parameters and return values
- Use dataclasses for structured data objects
- Disable pylint warnings with `# pylint: disable=C0103` when necessary (e.g., for Streamlit variable naming)

**Import Organization**:
```python
# Standard library imports
import sys
import datetime

# Third-party imports
import streamlit as st
import pandas as pd
import numpy as np

# Local imports
from utilities.utilities import AssetDetails
from utilities.constants import BASE_CURRENCY_OPTIONS
```

**Streamlit Patterns**:
- Use `st.set_page_config()` at the top of each page
- Organize page content with clear headers and sections
- Use `st.write()` for text content and `st.markdown()` for formatted text
- Implement query parameter handling for bookmarkable URLs
- Use `st.cache_data` for expensive data operations

**Data Classes**:
```python
@dataclass
class AssetPosition:
    """Asset position with symbol and position size"""
    symbol: str
    position: float
```

## Architecture Patterns

**Data Flow**:
1. **Data Fetching**: `utilities/app_yfinance.py` handles all Yahoo Finance API calls
2. **Data Processing**: `utilities/utilities.py` contains business logic and calculations
3. **Visualization**: `utilities/go_charts.py` creates Plotly charts
4. **Portfolio Analysis**: `classes/asset_positions.py` handles complex portfolio calculations

**Key Classes**:
- `AssetPosition`: Represents a position in a financial asset
- `Portfolio`: Comprehensive portfolio analysis with optimization strategies
- `PortfolioOptimizationResult`: Results from portfolio optimization algorithms
- `SectorOverview`: Market sector information and statistics

**Error Handling**:
- Use try-catch blocks for API calls to Yahoo Finance
- Provide fallback data or graceful degradation when external data is unavailable
- Display user-friendly error messages in Streamlit interface

## Development Workflow

**Setup**:
1. Run `.\1_setup_env.ps1` to create virtual environment and install dependencies
2. Run `.\2_run_streamlit_app.ps1` to start the application
3. Access app at `http://localhost:8501`

**Code Quality**:
- Run `pylint <file>.py --rcfile=.pylintrc` to check code quality
- Maintain 10.00/10 pylint rating when possible
- Use type hints consistently across the codebase

**Adding New Features**:
1. Create new pages in `pages/` directory with numbered prefix
2. Add utility functions to appropriate modules in `utilities/`
3. Update constants in `utilities/constants.py` if needed
4. Follow existing patterns for data fetching and visualization

## Key Dependencies and APIs

**Yahoo Finance (yfinance)**:
- Primary data source for financial information
- Use `yf.Ticker()` for individual assets
- Use `yf.download()` for historical data
- Handle rate limiting and API errors gracefully

**Financial Calculations**:
- Use log returns for portfolio optimization: `np.log(price / price.shift(1))`
- Compound Annual Growth Rate (CAGR): `(end_value / start_value) ^ (1/years) - 1`
- Sharpe ratio: `(return - risk_free_rate) / volatility`
- Portfolio optimization with scipy.optimize.minimize

**Data Processing Patterns**:
```python
# Common data transformation pattern
log_returns = np.log(prices / prices.shift(1)).dropna()
rolling_stats = log_returns.rolling(window=252).mean()  # 1-year rolling
```

## Testing and Validation

**Current State**: No formal test suite exists
**Data Validation**: Implement checks for valid symbols and data availability
**Performance**: Cache expensive calculations with Streamlit's caching mechanisms

## Common Tasks

**Adding a New Asset Analysis Page**:
1. Create `pages/N_New_Analysis.py`
2. Import required utilities and constants
3. Implement data fetching with error handling
4. Create visualizations using established chart patterns
5. Add interactive elements with Streamlit widgets

**Extending Portfolio Optimization**:
1. Add new strategy to `_calculate_portfolio_optimisation()` in `asset_positions.py`
2. Define objective function and constraints
3. Use scipy.optimize.minimize with SLSQP method
4. Return `PortfolioOptimizationResult` object

**Adding New Financial Metrics**:
1. Implement calculation in `utilities/utilities.py`
2. Add to appropriate data classes if needed
3. Update visualization functions in `utilities/go_charts.py`
4. Document metric calculation and interpretation

## Important Notes

- **Disclaimer**: Always include financial disclaimers about the informational nature of the analysis
- **Data Sources**: All financial data comes from Yahoo Finance via yfinance library
- **Currency Handling**: Support multiple base currencies defined in `BASE_CURRENCY_OPTIONS`
- **Performance**: Use Streamlit caching for expensive operations like portfolio optimization
- **Error Handling**: Gracefully handle network issues and invalid symbols
- **User Experience**: Provide clear loading indicators and error messages

## Development Environment

**Python Version**: 3.12+
**Package Management**: pip with requirements.txt
**IDE Configuration**: Configure for 120-character line length
**Debugging**: Use print statements and Streamlit's built-in error display

When contributing to this codebase, maintain consistency with existing patterns, prioritize user experience, and ensure financial calculations are accurate and well-documented.